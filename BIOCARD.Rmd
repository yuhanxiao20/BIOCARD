---
title: "BIOCARD Data Analysis"
author: "Yuhan Xiao"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = FALSE, warning = FALSE,
                      fig.align = "center", fig.height = 6, fig.width = 12)
library(readxl)
library(tidyverse)
library(mice)
library(knitr)
library(kableExtra)
library(lmerTest) 
library(gridExtra)
```

```{r}
# Load raw data
raw_demo <- read_excel("BIOCARD_Demographics_2024.08.07_Deidentified.xlsx", sheet = "BIOCARD_Demographics")
raw_dx <- read_excel("BIOCARD_DiagnosisData_2024.09.08_Deidentified.xlsx", sheet = "BIOCARD_DiagnosisData")
raw_act <- read_excel("actigraphy_data_BIOCARD_8_7_24_from Daniel_Deidentified.xlsx", sheet = "actigraphy_data_BIOCARD_8_7_24")
raw_gene <- read_excel("BIOCARD_Genetics_Data_2023.03.28_Deidentified.xlsx", sheet = "GENETICS_Data")
raw_champs <- read_excel("BIOCARD_Leisure_Activity_Champs_2023.09.10_other coded_Deidentified.xlsx", sheet = "BIOCARD_PA_BloodBiomarkers-CHAM")
# NTK often stands for NeuroToolKit. NTK is a set of biomarkers used for neurological and neurodegenerative disease research
raw_ntk <- read_excel("BIOCARD_NTK Blood biomarkers_08.09.24_JHU only.xlsx", sheet = "NTK Datafile to Use_JHU only")
raw_vital <- read_excel("BIOCARD_Vital_Signs_Sensory_2023.04.17_Deidentified.xlsx", sheet = "BIOCARD_VITAL_SIGNS_SENSORY")
raw_gene_new <- read_excel("New participants_BIOCARD ApoE Genotypes 2023-2024_Deidentified.xlsx", sheet = "Sheet1")

# Check missingness
# data %>%
#   summarise(across(everything(), ~ sum(is.na(.))))
# md.pattern(data)
```

```{r}
# Clean data

# Demographics data
# Sex: 1=Male|2=Female
# Educ: years of education, 12=Min|20=Max|99=Unknown|Blank
#   no unknown or missing
# Race: 1=White|2=Black or African American|3=American Indian or Alaska Native|4=Native Hawaiian or Other Pacific Islander|5=Asian|99=Unknown|Blank
#   no 4 or missing
# Sex_F: 1=F|0=M
# Race_White: 1=White|0=Other|99=Missing
data_demo <- raw_demo %>%
  select(SUBJECT_ID, SEX, EDUC, RACE) %>%
  mutate(Sex_F = ifelse(SEX == 2, 1, 0)) %>% 
  mutate(Race_White = case_when(
    RACE == 1 ~ 1,
    RACE %in% c(2,3,4,5) ~ 0,
    TRUE ~ 99
  )) %>%
  select(SUBJECT_ID, Sex_F, Race_White, EDUC) %>%
  mutate(in_demo = 1)
# check data
# data_demo %>% 
#   select(EDUC, Race_White, Sex_F) %>%
#   table()
# data_demo$SUBJECT_ID[duplicated(data_demo$SUBJECT_ID)] 
# length(unique(data_demo$SUBJECT_ID)) 
# 474 subjects

# Diagnosis data
# fup_Dx: 1 if last available (i.e., most recent) ‘DIAGNOSIS’ = MCI or dementia, otherwise 0
data_dx <- raw_dx %>%
  select(SUBJECT_ID, VISITNO, AgeAtVisit, DIAGNOSIS, DECAGE) %>%
  group_by(SUBJECT_ID) %>% 
  mutate(last_visit = ifelse(AgeAtVisit == max(AgeAtVisit), 1, 0)) %>%
  ungroup() %>%
  mutate(fup_Dx = ifelse(DIAGNOSIS %in% c("DEMENTIA", "MCI") & last_visit == 1, 1, 0)) %>%
  mutate(in_dx = 1)
# check data
# table(data_dx$DIAGNOSIS)
# DEMENTIA, IMPAIRED NOT MCI, MCI, NORMAL 
# length(unique(data_dx$SUBJECT_ID))
# 474 subjects

# Blood biomarkers data
data_ntk <- raw_ntk %>%
  select(SUBJECT_ID, VISITNO,
         PTAU181_zscore, AB42AB40_zscore, # AD-specific measures
         NFL_zscore, YKL40_zscore, sTREM2_zscore, GFAP_zscore, # AD non-specific measures
         PTAU181_outlier, AB42AB40_outlier, NFL_outlier, YKL40_outlier, sTREM2_outlier, GFAP_outlier,
         GFAP, NFL, PTAU181, AB42AB40, PTAU181_AB42AB40, sTREM2, YKL40) %>% # outlier indicators for each biomarker measure 
  mutate(in_ntk = 1)
# check data
# length(unique(data_ntk$SUBJECT_ID))
# 266 subjects

# CHAMPS activity questionnaire data
low_freq_vars <- c("B11110a_freq", "B11120a_freq", "B11122a_freq", "B11127a_freq", "B11128a_freq", "B11134a_freq", "B11135a_freq", "B11139a_freq")
high_freq_vars <- c("B11107a_freq", "B11109a_freq", "B11114a_freq", "B11115a_freq", "B11116a_freq", "B11119a_freq", "B11121a_freq", "B11123a_freq", "B11124a_freq", "B11125a_freq", "B11126a_freq", "B11129a_freq", "B11130a_freq", "B11131a_freq", "B11132a_freq", "B11133a_freq", "B11136a_freq", "B11137a_freq", "B11138a_freq", "B11140a_freq")
# Create three continuous variables reflecting each participant’s frequency of engagement in low intensity physical activities, high intensity physical activities, and all physical activities (regardless of level of intensity)
data_champs <- raw_champs %>%
  select(c(SUBJECT_ID, VISITNO, low_freq_vars, high_freq_vars, "B11141a_freq", "B11141s_CAT")) %>%
  mutate(across(all_of(c(low_freq_vars, high_freq_vars, "B11141a_freq")), as.numeric)) %>%  
  mutate(
    LOW_INT_FREQ = rowSums(select(., all_of(low_freq_vars)), na.rm = TRUE) +
                   ifelse(!is.na(B11141s_CAT) & B11141s_CAT == "Physical-low", B11141a_freq, 0),
    HIGH_INT_FREQ = rowSums(select(., all_of(high_freq_vars)), na.rm = TRUE) +
                    ifelse(!is.na(B11141s_CAT) & B11141s_CAT == "Physical-modhi", B11141a_freq, 0),
    ALL_INT_FREQ = LOW_INT_FREQ + HIGH_INT_FREQ
  ) %>%
  select(SUBJECT_ID, VISITNO, LOW_INT_FREQ, HIGH_INT_FREQ, ALL_INT_FREQ) %>%
  mutate(in_champs = 1) %>%
  group_by(SUBJECT_ID) %>% 
  mutate(first_champs_visit = ifelse(VISITNO == min(VISITNO), 1, 0))
# check data
# length(unique(data_champs$SUBJECT_ID))
# 259 subjects

# Actigraphy data
# LTAC10 total average activity counts over the 10 most active hours of the day, averaged across 3 days with valid data
data_act <- raw_act %>%
  select(SUBJECT_ID, VISITNO, LTAC10) %>%
  mutate(in_act = 1) %>%
  group_by(SUBJECT_ID) %>% 
  mutate(first_act_visit = ifelse(VISITNO == min(VISITNO), 1, 0))
# check data
# length(unique(data_act$SUBJECT_ID))
# 240 subjects

# Genetics (APOE genetic status) data
data_gene_new <- raw_gene_new %>%
  filter(!is.na(SUBJECT_ID)) %>%
  mutate(APOECODE = APOECODE/10)

data_gene <- raw_gene %>%
  rbind(data_gene_new) %>%
  mutate(APOE4 = case_when(
      APOECODE %in% c(2.2, 2.3, 3.3) ~ 0,  
      APOECODE %in% c(2.4, 3.4, 4.4) ~ 1,  
      APOECODE == "" | is.na(APOECODE) ~ NA_real_ 
    )) %>%
  mutate(in_gene = 1)
# check data
# length(unique(data_gene$SUBJECT_ID))
# 467 subjects

# Vital signs/ sensory data
# use self-reported BMI if measured BMI is not available
data_vital <- raw_vital %>%
  select(SUBJECT_ID, VISITNO, BMI, BMISR) %>%
  rename(BMI_measured = BMI) %>%
  mutate(in_vital = 1) %>%
  mutate(BMI = ifelse(is.na(BMI_measured), BMISR, BMI_measured)) %>%
  select(-c(BMI_measured, BMISR))
# check data
# length(unique(data_vital$SUBJECT_ID))
# 394 subjects
```

```{r}
# Data merge
# format variables to merge on
format_columns <- c("SUBJECT_ID","VISITNO")
data_dx[format_columns] <- lapply(data_dx[format_columns], as.numeric) 
data_act[format_columns] <- lapply(data_act[format_columns], as.numeric) 

# biomarker variables
ntk_vars = c("PTAU181_zscore", "AB42AB40_zscore", "NFL_zscore", "YKL40_zscore",
             "sTREM2_zscore", "GFAP_zscore", "PTAU181_outlier", "AB42AB40_outlier",
             "NFL_outlier", "YKL40_outlier", "sTREM2_outlier", "GFAP_outlier", 
             "in_ntk",
             "PTAU181", "AB42AB40", "NFL", "YKL40", "sTREM2", "GFAP", "PTAU181_AB42AB40")

# CHAMPS analysis
data_champs_merged <- data_champs %>%
  merge(data_dx, by = c("SUBJECT_ID", "VISITNO"), all = TRUE) %>%
  merge(data_ntk, by = c("SUBJECT_ID", "VISITNO"), all = TRUE) %>%
  merge(data_vital, by = c("SUBJECT_ID", "VISITNO"), all = TRUE) %>%
  merge(data_demo, by = "SUBJECT_ID", all = TRUE) %>%
  merge(data_gene, by = "SUBJECT_ID", all = TRUE) %>%
  arrange(SUBJECT_ID, VISITNO)
# 474 patients

# Identify patients with MCI or Dementia at the first CHAMPS visit
excluded_patients <- data_champs_merged %>%
  filter(first_champs_visit == 1 & (DIAGNOSIS == "MCI" | DIAGNOSIS == "DEMENTIA")) %>%
  pull(SUBJECT_ID)
# 39 patients

# check if a participant has at least one CHAMPS assessment
# define Age_CHAMPS as a participant’s age at their baseline/first available CHAMPS assessment 
# exclude patients with a diagnosis of MCI or dementia at baseline CHAMPS assessment
data_champs_clean <- data_champs_merged %>%
  group_by(SUBJECT_ID) %>%
  filter(any(in_champs == 1)) %>%
  mutate(Age_CHAMPS = ifelse(first_champs_visit == 1, AgeAtVisit, NA)) %>%
  fill(Age_CHAMPS, .direction = "downup") %>%
  filter(!SUBJECT_ID %in% excluded_patients) %>%
  ungroup() 
# length(unique(data_champs_clean$SUBJECT_ID))
# 220 patients

# Identify patients without biomarker info 1.5 years around baseline CHAMPS visit
no_ntk_at_baseline_visit <- data_champs_clean %>%
  filter(first_champs_visit == 1 & is.na(in_ntk)) %>%
  pull(SUBJECT_ID)
# 52 patients don't have biomarker info at the baseline visit
# 9 out of 52 patients are diagnosed with MCI or Dementia at baseline

ntk_within_window_patients <- data_champs_clean %>%
  filter(SUBJECT_ID %in% no_ntk_at_baseline_visit) %>%
  mutate(ntk_within_window = ifelse(
      (abs(AgeAtVisit - Age_CHAMPS) <= 1.5) &
      !is.na(in_ntk), 
    1, 0
  ))  %>%
  filter(ntk_within_window == 1) %>%
  select(c(SUBJECT_ID, AgeAtVisit, all_of(ntk_vars))) %>%
  group_by(SUBJECT_ID) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  mutate(first_champs_visit = 1) %>%
  mutate(Age_NTK_bl = AgeAtVisit)
# 4 patients

data_champs_clean <- data_champs_clean %>%
  filter(!(SUBJECT_ID %in% no_ntk_at_baseline_visit) | 
           SUBJECT_ID %in% ntk_within_window_patients$SUBJECT_ID) %>%
  # only include visits from baseline forward for each patient
  group_by(SUBJECT_ID) %>%
  mutate(baseline_forward = ifelse(first_champs_visit == 1, 1, NA)) %>%
  fill(baseline_forward, .direction = "down") %>%
  filter(baseline_forward == 1)  %>%
  # update biomarker info for patients with missing biomarker at baseline
  merge(ntk_within_window_patients, all.x = TRUE, 
        by = c("SUBJECT_ID", "first_champs_visit"), suffix = c("_left", "_right")) %>%
   mutate(
    across(
      .cols = ends_with("_left"),  
      .fns = ~ ifelse(!is.na(.), ., get(str_remove(cur_column(), "_left") %>% paste0("_right"))),  
      .names = "{str_remove(.col, '_left')}"  
    )
  )%>%
  select(-ends_with("_left"), -ends_with("_right")) %>%
  mutate(Age_NTK_bl = ifelse(!is.na(Age_NTK_bl), Age_NTK_bl, AgeAtVisit)) %>%
  # only include visits with biomarker information
  filter(in_ntk == 1)
# length(unique(data_champs_clean$SUBJECT_ID))
# 181 patients, 750 visits

# Check missingness
# data_champs_clean %>%
#   summarise(across(everything(), ~ sum(is.na(.))))
# md.pattern(data_champs_clean)
```

```{r}
# Data merge
# Actigraphy analysis
data_act_merged <- data_act %>%
  merge(data_dx, by = c("SUBJECT_ID", "VISITNO"), all = TRUE) %>%
  merge(data_ntk, by = c("SUBJECT_ID", "VISITNO"), all = TRUE) %>%
  merge(data_vital, by = c("SUBJECT_ID", "VISITNO"), all = TRUE) %>%
  merge(data_demo, by = "SUBJECT_ID", all = TRUE) %>%
  merge(data_gene, by = "SUBJECT_ID", all = TRUE) %>%
  arrange(SUBJECT_ID, VISITNO)
# 474 patients

# Identify patients with MCI or Dementia at the first Actigraphy visit
excluded_patients <- data_act_merged %>%
  filter(first_act_visit == 1 & (DIAGNOSIS == "MCI" | DIAGNOSIS == "DEMENTIA")) %>%
  pull(SUBJECT_ID)
# 27 patients

# Include patients in the CHAMPS analysis
# Include patients with at least one actigraphy assessment
# define Age_Act as a participant’s age at their baseline/first available Actigraphy assessment 
# exclude patients with a diagnosis of MCI or dementia at baseline Actigraphy assessment
data_act_clean <- data_act_merged %>%
  filter(SUBJECT_ID %in% data_champs_clean$SUBJECT_ID) %>%
  group_by(SUBJECT_ID) %>%
  filter(any(in_act == 1)) %>%
  mutate(Age_Act = ifelse(first_act_visit == 1, AgeAtVisit, NA)) %>%
  fill(Age_Act, .direction = "downup") %>%
  filter(!SUBJECT_ID %in% excluded_patients) %>%
  ungroup() 
# length(unique(data_act_clean$SUBJECT_ID))
# 160 patients

# Identify patients without biomarker info 1.5 years around baseline Actigraphy visit
no_ntk_at_baseline_visit <- data_act_clean %>%
  filter(first_act_visit == 1 & is.na(in_ntk)) %>%
  pull(SUBJECT_ID)
# 8 patients don't have biomarker info at the baseline visit
# 1 out of 8 patients are diagnosed with MCI or Dementia at baseline

ntk_within_window_patients <- data_act_clean %>%
  filter(SUBJECT_ID %in% no_ntk_at_baseline_visit) %>%
  mutate(ntk_within_window = ifelse(
      (abs(AgeAtVisit - Age_Act) <= 1.5) &
      !is.na(in_ntk), 
    1, 0
  )) %>%
  filter(ntk_within_window == 1) %>%
  select(c(SUBJECT_ID, AgeAtVisit,all_of(ntk_vars))) %>%
  group_by(SUBJECT_ID) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  mutate(first_act_visit = 1) %>%
  mutate(Age_NTK_bl = AgeAtVisit)
# 4 patients

data_act_clean <- data_act_clean %>%
  filter(!(SUBJECT_ID %in% no_ntk_at_baseline_visit) | 
           SUBJECT_ID %in% ntk_within_window_patients$SUBJECT_ID) %>%
  # only include visits from baseline forward for each patient
  group_by(SUBJECT_ID) %>%
  mutate(baseline_forward = ifelse(first_act_visit == 1, 1, NA)) %>%
  fill(baseline_forward, .direction = "down") %>%
  filter(baseline_forward == 1) %>%
  # update biomarker info for patients with missing biomarker at baseline
  merge(ntk_within_window_patients, all.x = TRUE, 
        by = c("SUBJECT_ID", "first_act_visit"), suffix = c("_left", "_right")) %>%
   mutate(
    across(
      .cols = ends_with("_left"),  
      .fns = ~ ifelse(!is.na(.), ., get(str_remove(cur_column(), "_left") %>% paste0("_right"))),  
      .names = "{str_remove(.col, '_left')}"  
    )
  )%>%
  select(-ends_with("_left"), -ends_with("_right")) %>%
  mutate(Age_NTK_bl = ifelse(!is.na(Age_NTK_bl), Age_NTK_bl, AgeAtVisit)) %>%
  # only include visits with biomarker information
  filter(in_ntk == 1)
# length(unique(data_act_clean$SUBJECT_ID))
# 157 patients, 431 visits
```

## Descriptive Statistics
### CHAMPS Analyses
```{r}
data_champs_clean <- data_champs_clean %>%
  arrange(SUBJECT_ID, VISITNO)

# only contain baseline info for each patient
# calculate follow up time 
data_champs_clean_bl <- data_champs_clean %>%
  group_by(SUBJECT_ID) %>%
  mutate(follow_up_time = max(AgeAtVisit) - Age_CHAMPS) %>%
  fill(follow_up_time, .direction = "downup") %>%
  mutate(n_ntk = n()) %>%
  slice_head(n = 1) %>%
  ungroup()

summary_stats <- data.frame(
  # Total number of participants
  N = nrow(data_champs_clean_bl),

  # Number with a diagnosis of MCI or dementia at last visit
  N_with_MCI_dementia = sum(data_champs_clean$fup_Dx == 1, na.rm = TRUE),
  
  # Number of participants with 'Subject_ID' ≥ 400
  N_participants_400 = sum(data_champs_clean_bl$SUBJECT_ID >= 400, na.rm = TRUE),
  
  # Mean (SD) Age_CHAMPS
  Mean_Age_CHAMPS = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE), sd(data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE)),
  
  # Range of Age_CHAMPS
  Range_Age_CHAMPS = sprintf("(%.2f, %.2f)", min(data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE), max(data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE)),
  
  # N (%) female sex
  N_female = sum(data_champs_clean_bl$Sex_F == 1, na.rm = TRUE),
  Percent_female = sprintf("%.2f%%", (sum(data_champs_clean_bl$Sex_F == 1, na.rm = TRUE) / nrow(data_champs_clean_bl)) * 100),
  
  # Mean (SD) years of education
  Mean_EDUC = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$EDUC, na.rm = TRUE), sd(data_champs_clean_bl$EDUC, na.rm = TRUE)),
  
  # N (%) White race
  N_white = sum(data_champs_clean_bl$Race_White == 1, na.rm = TRUE),
  Percent_white = sprintf("%.2f%%", (sum(data_champs_clean_bl$Race_White == 1, na.rm = TRUE) / nrow(data_champs_clean_bl)) * 100),
  
  # N (%) APOE4 carriers
  N_APOE4 = sum(data_champs_clean_bl$APOE4 == 1, na.rm = TRUE),
  Percent_APOE4 = sprintf("%.2f%%", (sum(data_champs_clean_bl$APOE4 == 1, na.rm = TRUE) / nrow(data_champs_clean_bl)) * 100),
  
  # Mean (SD) years of follow-up
  Mean_Followup = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$follow_up_time, na.rm = TRUE), sd(data_champs_clean_bl$follow_up_time, na.rm = TRUE)),
  
  # Range of years of follow-up
  Range_Followup = sprintf("(%.2f, %.2f)", min(data_champs_clean_bl$follow_up_time, na.rm = TRUE), max(data_champs_clean_bl$follow_up_time, na.rm = TRUE)),
  
  # Mean (SD) number of blood biomarker measures
  Mean_Biomarkers = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$n_ntk, na.rm = TRUE), sd(data_champs_clean_bl$n_ntk, na.rm = TRUE)),
  
  # Range of number of blood biomarker measures
  Range_Biomarkers = sprintf("(%.2f, %.2f)", min(data_champs_clean_bl$n_ntk, na.rm = TRUE), max(data_champs_clean_bl$n_ntk, na.rm = TRUE)),
  
  # Mean (SD) time (in years) 
  Mean_Time = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$Age_NTK_bl - data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE), sd(data_champs_clean_bl$Age_NTK_bl - data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE)),
  
  # Mean Range (min, max) time (in years) 
  Range_Time = sprintf("(%.2f, %.2f)", min(data_champs_clean_bl$Age_NTK_bl - data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE), max(data_champs_clean_bl$Age_NTK_bl - data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE)),
  
  # Mean (SD) LOW_INT_FREQ
  Mean_LOW_INT = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$LOW_INT_FREQ, na.rm = TRUE), sd(data_champs_clean_bl$LOW_INT_FREQ, na.rm = TRUE)),
  
  # Mean (SD) HI_INT_FREQ
  Mean_HI_INT = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$HIGH_INT_FREQ, na.rm = TRUE), sd(data_champs_clean_bl$HIGH_INT_FREQ, na.rm = TRUE)),
  
  # Mean (SD) ALL_INT_FREQ
  Mean_ALL_INT = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$ALL_INT_FREQ, na.rm = TRUE), sd(data_champs_clean_bl$ALL_INT_FREQ, na.rm = TRUE)),
  
  # Mean (SD) BMI
  Mean_BMI = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl$BMI, na.rm = TRUE), sd(data_champs_clean_bl$BMI, na.rm = TRUE)),
  
  # Mean (SD) GFAP at baseline CHAMPS
  Mean_GFAP = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$GFAP_outlier==0,]$GFAP, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$GFAP_outlier==0,]$GFAP, na.rm = TRUE)),
  
  # Mean (SD) NFL at baseline CHAMPS
  Mean_NFL = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$NFL_outlier==0,]$NFL, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$NFL_outlier==0,]$NFL, na.rm = TRUE)),
  
  # Mean (SD) PTAU181 at baseline CHAMPS
  Mean_PTAU181 = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$PTAU181_outlier==0,]$PTAU181, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$PTAU181_outlier==0,]$PTAU181, na.rm = TRUE)),
  
  # Mean (SD) AB42AB40 at baseline CHAMPS
  Mean_AB42AB40 = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$AB42AB40_outlier==0,]$AB42AB40, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$AB42AB40_outlier==0,]$AB42AB40, na.rm = TRUE)),
  
  # Mean (SD) PTAU181_AB42AB40 at baseline CHAMPS
  Mean_PTAU181_AB42AB40 = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$AB42AB40_outlier==0 & data_champs_clean_bl$PTAU181_outlier==0,]$PTAU181_AB42AB40, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$AB42AB40_outlier==0 & data_champs_clean_bl$PTAU181_outlier==0,]$PTAU181_AB42AB40, na.rm = TRUE)),
  
  # Mean (SD) sTREM2 at baseline CHAMPS
  Mean_sTREM2 = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$sTREM2_outlier==0,]$sTREM2, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$sTREM2_outlier==0,]$sTREM2, na.rm = TRUE)),
  
  # Mean (SD) YKL40 at baseline CHAMPS
  Mean_YKL40 = sprintf("%.2f (%.2f)", mean(data_champs_clean_bl[data_champs_clean_bl$YKL40_outlier==0,]$YKL40, na.rm = TRUE), sd(data_champs_clean_bl[data_champs_clean_bl$YKL40_outlier==0,]$YKL40, na.rm = TRUE))
)
```

```{r}
summary_stats <- as.data.frame(t(summary_stats))
summary_stats$Variable = c("N", 
                           "N with a diagnosis of MCI or dementia at last visit (‘fup_Dx’ = 1)",
                           "N participants with ‘Subject_ID’ ≥ 400 *",
                           "Mean (SD) Age_CHAMPS", 
                           "Range (min, max) Age_CHAMPS", 
                           "N female sex (‘Sex_F’ = 1)", 
                           "% female sex (‘Sex_F’ = 1)", 
                           "Mean (SD) years of education (‘EDUC’) ",
                           "N White race (‘Race_White’ = 1)", 
                           "% White race (‘Race_White’ = 1)", 
                           "N APOE4 carriers (‘APOE4’ = 1)",
                           "% APOE4 carriers (‘APOE4’ = 1)",
                           "Mean (SD) years of follow-up (baseline CHAMPS to last blood biomarker measure)",
                           "Range (min, max) years of follow-up (baseline CHAMPS to last blood biomarker measure)", 
                           "Mean (SD) number of blood biomarker measures over time", 
                           "Range (min, max) number of blood biomarker measures over time",
                           "Mean (SD) time (in years) between baseline CHAMPS and associated baseline blood biomarker measure",
                           "Range (min, max) time (in years) between baseline CHAMPS and associated baseline blood biomarker measure", 
                           "Mean (SD) LOW_INT_FREQ", 
                           "Mean (SD) HI_INT_FREQ",
                           "Mean (SD) ALL_INT_FREQ",
                           "Mean (SD) BMI", 
                           "Mean (SD) GFAP at baseline actigraphy", 
                           "Mean (SD) NFL at baseline actigraphy", 
                           "Mean (SD) PTAU181 at baseline actigraphy", 
                           "Mean (SD) AB42AB40 at baseline actigraphy", 
                           "Mean (SD) PTAU181_AB42AB40 at baseline actigraphy", 
                           "Mean (SD) sTREM2 at baseline actigraphy", 
                           "Mean (SD) YKL40 at baseline actigraphy"
)
colnames(summary_stats) = c("Participants in analyses", "")

summary_stats %>%
  kable(caption = "Descriptive Statistics for Participants Included in the CHAMPS Analyses")
```

### Actigraphy Analyses
```{r}
data_act_clean <- data_act_clean %>%
  arrange(SUBJECT_ID, VISITNO)

# only contain baseline info for each patient
# calculate follow up time
data_act_clean_bl <- data_act_clean %>%
  group_by(SUBJECT_ID) %>%
  mutate(follow_up_time = max(AgeAtVisit) - Age_Act) %>%
  fill(follow_up_time, .direction = "downup") %>%
  mutate(n_ntk = n()) %>%
  slice_head(n = 1) %>%
  ungroup()

# add champs data to actigraphy data on a patient level
data_act_clean_champs <- data_act_clean_bl %>%
  select(c(SUBJECT_ID, Age_Act)) %>%
  left_join(select(data_champs_clean_bl, SUBJECT_ID, Age_CHAMPS), by = "SUBJECT_ID") %>%
  mutate(Age_diff = Age_CHAMPS-Age_Act)

summary_stats <- data.frame(
  # Total number of participants
  N = nrow(data_act_clean_bl),

  # Number with a diagnosis of MCI or dementia at last visit
  N_with_MCI_dementia = sum(data_act_clean_bl$fup_Dx == 1, na.rm = TRUE),
  
  # Number of participants with 'Subject_ID' ≥ 400
  N_participants_400 = sum(data_act_clean_bl$SUBJECT_ID >= 400, na.rm = TRUE),
  
  # Mean (SD) Age_Act
  Mean_Age_Act = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$Age_Act, na.rm = TRUE), sd(data_act_clean_bl$Age_Act, na.rm = TRUE)),
  
  # Range of Age_Act
  Range_Age_Act = sprintf("(%.2f, %.2f)", min(data_act_clean_bl$Age_Act, na.rm = TRUE), max(data_act_clean_bl$Age_Act, na.rm = TRUE)),
  
  # N (%) female sex
  N_female = sum(data_act_clean_bl$Sex_F == 1, na.rm = TRUE),
  Percent_female = sprintf("%.2f%%", (sum(data_act_clean_bl$Sex_F == 1, na.rm = TRUE) / nrow(data_act_clean_bl)) * 100),
  
  # Mean (SD) years of education
  Mean_EDUC = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$EDUC, na.rm = TRUE), sd(data_act_clean_bl$EDUC, na.rm = TRUE)),
  
  # N (%) White race
  N_white = sum(data_act_clean_bl$Race_White == 1, na.rm = TRUE),
  Percent_white = sprintf("%.2f%%", (sum(data_act_clean_bl$Race_White == 1, na.rm = TRUE) / nrow(data_act_clean_bl)) * 100),
  
  # N (%) APOE4 carriers
  N_APOE4 = sum(data_act_clean_bl$APOE4 == 1, na.rm = TRUE),
  Percent_APOE4 = sprintf("%.2f%%", (sum(data_act_clean_bl$APOE4 == 1, na.rm = TRUE) / nrow(data_act_clean_bl)) * 100),
  
  # Mean (SD) years of Age_CHAMPS - Age_Act
  Mean_Age_Diff = sprintf("%.2f (%.2f)", mean(data_act_clean_champs$Age_diff, na.rm = TRUE), sd(data_act_clean_champs$Age_diff, na.rm = TRUE)),
  
  # Range of years of Age_CHAMPS - Age_Act
  Range_Age_Diff = sprintf("(%.2f, %.2f)", min(data_act_clean_champs$Age_diff, na.rm = TRUE), max(data_act_clean_champs$Age_diff, na.rm = TRUE)),
  
  # Mean (SD) years of follow-up
  Mean_Followup = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$follow_up_time, na.rm = TRUE), sd(data_act_clean_bl$follow_up_time, na.rm = TRUE)),
  
  # Range of years of follow-up
  Range_Followup = sprintf("(%.2f, %.2f)", min(data_act_clean_bl$follow_up_time, na.rm = TRUE), max(data_act_clean_bl$follow_up_time, na.rm = TRUE)),
  
  # Mean (SD) number of blood biomarker measures
  Mean_Biomarkers = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$n_ntk, na.rm = TRUE), sd(data_act_clean_bl$n_ntk, na.rm = TRUE)),
  
  # Range of number of blood biomarker measures
  Range_Biomarkers = sprintf("(%.2f, %.2f)", min(data_act_clean_bl$n_ntk, na.rm = TRUE), max(data_act_clean_bl$n_ntk, na.rm = TRUE)),
  
  # Mean (SD) time (in years) 
  Mean_Time = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$Age_NTK_bl - data_act_clean_bl$Age_Act, na.rm = TRUE), sd(data_act_clean_bl$Age_NTK_bl - data_act_clean_bl$Age_Act, na.rm = TRUE)),
  
  # Mean Range (min, max) time (in years) 
  Range_Time = sprintf("(%.2f, %.2f)", min(data_act_clean_bl$Age_NTK_bl - data_act_clean_bl$Age_Act, na.rm = TRUE), max(data_act_clean_bl$Age_NTK_bl - data_act_clean_bl$Age_Act, na.rm = TRUE)),
  
  # Mean (SD) LTAC
  Mean_LTAC = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$LTAC10, na.rm = TRUE), sd(data_act_clean_bl$LTAC10, na.rm = TRUE)),
  
  # Mean (SD) BMI
  Mean_BMI = sprintf("%.2f (%.2f)", mean(data_act_clean_bl$BMI, na.rm = TRUE), sd(data_act_clean_bl$BMI, na.rm = TRUE)),
  
  # Mean (SD) GFAP at baseline CHAMPS
  Mean_GFAP = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$GFAP_outlier==0,]$GFAP, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$GFAP_outlier==0,]$GFAP, na.rm = TRUE)),
  
  # Mean (SD) NFL at baseline CHAMPS
  Mean_NFL = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$NFL_outlier==0,]$NFL, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$NFL_outlier==0,]$NFL, na.rm = TRUE)),
  
  # Mean (SD) PTAU181 at baseline CHAMPS
  Mean_PTAU181 = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$PTAU181_outlier==0,]$PTAU181, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$PTAU181_outlier==0,]$PTAU181, na.rm = TRUE)),
  
  # Mean (SD) AB42AB40 at baseline CHAMPS
  Mean_AB42AB40 = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$AB42AB40_outlier==0,]$AB42AB40, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$AB42AB40_outlier==0,]$AB42AB40, na.rm = TRUE)),
  
  # Mean (SD) PTAU181_AB42AB40 at baseline CHAMPS
  Mean_PTAU181_AB42AB40 = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$AB42AB40_outlier==0 & data_act_clean_bl$PTAU181_outlier==0,]$PTAU181_AB42AB40, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$AB42AB40_outlier==0 & data_act_clean_bl$PTAU181_outlier==0,]$PTAU181_AB42AB40, na.rm = TRUE)),
  
  # Mean (SD) sTREM2 at baseline CHAMPS
  Mean_sTREM2 = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$sTREM2_outlier==0,]$sTREM2, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$sTREM2_outlier==0,]$sTREM2, na.rm = TRUE)),
  
  # Mean (SD) YKL40 at baseline CHAMPS
  Mean_YKL40 = sprintf("%.2f (%.2f)", mean(data_act_clean_bl[data_act_clean_bl$YKL40_outlier==0,]$YKL40, na.rm = TRUE), sd(data_act_clean_bl[data_act_clean_bl$YKL40_outlier==0,]$YKL40, na.rm = TRUE))
)
```

```{r}
summary_stats <- as.data.frame(t(summary_stats))
summary_stats$Variable = c("N", 
                           "N with a diagnosis of MCI or dementia at last visit (‘fup_Dx’ = 1)",
                           "N participants with ‘Subject_ID’ ≥ 400 *",
                           "Mean (SD) Age_Act", "Range (min, max) Age_Act", 
                           "N female sex (‘Sex_F’ = 1)", 
                           "% female sex (‘Sex_F’ = 1)", 
                           "Mean (SD) years of education (‘EDUC’) ",
                           "N White race (‘Race_White’ = 1)", 
                           "% White race (‘Race_White’ = 1)", 
                           "N APOE4 carriers (‘APOE4’ = 1)",
                           "% APOE4 carriers (‘APOE4’ = 1)",
                           "Mean (SD) years between Age_CHAMPS and Age_Act", 
                           "Range (min, max) years between Age_CHAMPS and Age_Act", 
                           "Mean (SD) years of follow-up (baseline actigraphy to last blood biomarker measure)",
                           "Range (min, max) years of follow-up (baseline actigraphy to last blood biomarker measure)", 
                           "Mean (SD) number of blood biomarker measures over time", 
                           "Range (min, max) number of blood biomarker measures over time",
                           "Mean (SD) time (in years) between baseline actigraphy and associated baseline blood biomarker measure",
                           "Range (min, max) time (in years) between baseline actigraphy and associated baseline blood biomarker measure", 
                           "Mean (SD) LTAC10", 
                           "Mean (SD) BMI", 
                           "Mean (SD) GFAP at baseline actigraphy", 
                           "Mean (SD) NFL at baseline actigraphy", 
                           "Mean (SD) PTAU181 at baseline actigraphy", 
                           "Mean (SD) AB42AB40 at baseline actigraphy", 
                           "Mean (SD) PTAU181_AB42AB40 at baseline actigraphy", 
                           "Mean (SD) sTREM2 at baseline actigraphy", 
                           "Mean (SD) YKL40 at baseline actigraphy"
)
colnames(summary_stats) = c("Participants in analyses", "")

summary_stats %>%
  kable(caption = "Descriptive Statistics for Participants Included in the Actigraphy Analyses")
```

## Regression Models
### CHAMPS Analyses
```{r}
# prepare data for regression analysis
model_vars = c("Age_CHAMPS_z", "bl_sex", "bl_APOE4", "bl_BMI_z", "bl_low_z", 
               "bl_high_z","bl_all_z","time")

# mutate baseline characteristics
data_champs_model <- data_champs_clean %>%
  mutate(time = AgeAtVisit - Age_CHAMPS) %>%
  arrange(SUBJECT_ID, VISITNO) %>%
  group_by(SUBJECT_ID) %>%
  mutate(bl_sex = ifelse(first_champs_visit == 1, Sex_F, NA),
         bl_APOE4 = ifelse(first_champs_visit == 1, APOE4, NA),
         bl_BMI = ifelse(first_champs_visit == 1, BMI, NA),
         bl_low = ifelse(first_champs_visit == 1, LOW_INT_FREQ, NA),
         bl_high = ifelse(first_champs_visit == 1, HIGH_INT_FREQ, NA),
         bl_all = ifelse(first_champs_visit == 1, ALL_INT_FREQ, NA)
         ) %>%
  # standardize continuous predictors
  mutate(bl_sex = as.factor(bl_sex),
         bl_APOE4 = as.factor(bl_APOE4),
         Age_CHAMPS_z = (Age_CHAMPS - mean(data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE)) / sd(data_champs_clean_bl$Age_CHAMPS, na.rm = TRUE),
         bl_BMI_z = (bl_BMI - mean(data_champs_clean_bl$BMI, na.rm = TRUE)) / sd(data_champs_clean_bl$BMI, na.rm = TRUE),
         bl_low_z = (bl_low - mean(data_champs_clean_bl$LOW_INT_FREQ, na.rm = TRUE)) / sd(data_champs_clean_bl$LOW_INT_FREQ, na.rm = TRUE),
         bl_high_z = (bl_high - mean(data_champs_clean_bl$HIGH_INT_FREQ, na.rm = TRUE)) / sd(data_champs_clean_bl$HIGH_INT_FREQ, na.rm = TRUE),
         bl_all_z = (bl_all - mean(data_champs_clean_bl$ALL_INT_FREQ, na.rm = TRUE)) / sd(data_champs_clean_bl$ALL_INT_FREQ, na.rm = TRUE)
         ) %>%
  fill(bl_sex, .direction = "down") %>%
  fill(bl_APOE4, .direction = "down") %>%
  fill(Age_CHAMPS_z, .direction = "down") %>%
  fill(bl_BMI_z, .direction = "down") %>%
  fill(bl_low_z, .direction = "down") %>%
  fill(bl_high_z, .direction = "down") %>%
  fill(bl_all_z, .direction = "down") 
# 9 rows missing BMI

data_champs_GFAP <- data_champs_model %>%
  select(c(SUBJECT_ID, model_vars, 
           GFAP_zscore, GFAP_outlier)) %>%
  filter(GFAP_outlier == 0) %>%
  select(-c(GFAP_outlier))

data_champs_NFL <- data_champs_model %>%
  select(c(SUBJECT_ID, model_vars, 
           NFL_zscore, NFL_outlier)) %>%
  filter(NFL_outlier == 0) %>%
  select(-c(NFL_outlier))

data_champs_PTAU181 <- data_champs_model %>%
  select(c(SUBJECT_ID, model_vars, 
           PTAU181_zscore, PTAU181_outlier)) %>%
  filter(PTAU181_outlier == 0) %>%
  select(-c(PTAU181_outlier))

data_champs_AB42AB40 <- data_champs_model %>%
  select(c(SUBJECT_ID, model_vars, 
           AB42AB40_zscore, AB42AB40_outlier)) %>%
  filter(AB42AB40_outlier == 0) %>%
  select(-c(AB42AB40_outlier))

data_champs_sTREM2 <- data_champs_model %>%
  select(c(SUBJECT_ID, model_vars, 
           sTREM2_zscore, sTREM2_outlier)) %>%
  filter(sTREM2_outlier == 0) %>%
  select(-c(sTREM2_outlier))

data_champs_YKL40 <- data_champs_model %>%
  select(c(SUBJECT_ID, model_vars, 
           YKL40_zscore, YKL40_outlier)) %>%
  filter(YKL40_outlier == 0) %>%
  select(-c(YKL40_outlier))
```

### Model Specification

The linear mixed-effects model used in this analysis is specified as follows:

$$
Y_{ij} = \beta_0 + \beta_1 \text{time}_{ij} + \beta_2 \text{Age_CHAMPS}_i + \beta_3 \text{Sex_F}_i + \beta_4 \text{APOE4}_i + \beta_5 \text{BMI}_i + \beta_6 \text{CHAMPS}_i
+ \\ \beta_7 (\text{time}_{ij} \times \text{Age_CHAMPS}_i) + \beta_8 (\text{time}_{ij} \times \text{Sex_F}_i) + \beta_9 (\text{time}_{ij} \times \text{APOE4}_i) + \beta_{10} (\text{time}_{ij} \times \text{BMI}_i) + \beta_{11} (\text{time}_{ij} \times \text{CHAMPS}_i) \\
+ u_{0i} + u_{1i} \text{time}_{ij} + \epsilon_{ij}
$$

Where:

- $Y_{ij}$ is the biomarker outcome for participant $i$ at time $j$. 
- $\beta_0$ is the fixed intercept. 
- $\beta_1, \dots, \beta_{11}$ are the fixed effect coefficients. 
- $u_{0i} \sim N(0, \sigma^2_u)$ is the random intercept for subject $i$. 
- $u_{1i} \sim N(0, \sigma^2_v)$ is the random slope for time for subject $i$. 
- $\epsilon_{ij} \sim N(0, \sigma^2)$ is the residual error.

Low Intensity
```{r}
# Low intensity
# Fit the linear mixed model
model_GFAP_low <- lmerTest::lmer(GFAP_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_low_z) + (1 + time | SUBJECT_ID), data = data_champs_GFAP)
model_NFL_low <- lmerTest::lmer(NFL_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_low_z) + (1 + time | SUBJECT_ID), data = data_champs_NFL)
model_PTAU181_low <- lmerTest::lmer(PTAU181_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_low_z) + (1 + time | SUBJECT_ID), data = data_champs_PTAU181)
model_AB42AB40_low <- lmerTest::lmer(AB42AB40_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_low_z) + (1 + time | SUBJECT_ID), data = data_champs_AB42AB40)
model_sTREM2_low <- lmerTest::lmer(sTREM2_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_low_z) + (1 + time | SUBJECT_ID), data = data_champs_sTREM2)
model_YKL40_low <- lmerTest::lmer(YKL40_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_low_z) + (1 + time | SUBJECT_ID), data = data_champs_YKL40)

# View model summary
summary(model_GFAP_low)
summary(model_NFL_low)
summary(model_PTAU181_low)
summary(model_AB42AB40_low)
summary(model_sTREM2_low)
summary(model_YKL40_low)
```

```{r}
# Function to extract desired information from each model
extract_results <- function(model) {
  model_summary <- summary(model)
  
  estimate_main <- model_summary$coefficients[7, 1]
  std.error_main <- model_summary$coefficients[7, 2]
  t_value_main <- model_summary$coefficients[7, 4]
  p_value_main <- model_summary$coefficients[7, 5]
  
  estimate_interaction <- model_summary$coefficients[12, 1]
  std.error_interaction <- model_summary$coefficients[12, 2]
  t_value_interaction <- model_summary$coefficients[12, 4]
  p_value_interaction <- model_summary$coefficients[12, 5]
  
  result_main <- c(Estimate = estimate_main, Std.Error = std.error_main, T_value = t_value_main, P_value = p_value_main)
  result_interaction <- c(Estimate = estimate_interaction, Std.Error = std.error_interaction, T_value = t_value_interaction, P_value = p_value_interaction)
  
  return(rbind(result_main, result_interaction))
}

# Create a list of models
models <- list(
  GFAP = model_GFAP_low,
  NFL = model_NFL_low,
  PTAU181 = model_PTAU181_low,
  AB42AB40 = model_AB42AB40_low,
  sTREM2 = model_sTREM2_low,
  YKL40 = model_YKL40_low
)

results <- lapply(models, extract_results)
results_df <- do.call(rbind, results)
# Convert the row names (biomarker names) into a column
results_df <- data.frame(Biomarker = rep(names(models), each = 2), results_df, row.names = NULL)
results_df$Interaction <- rep(c("Low Intensity", "Low Intensity * Time"), length(models))
results_df <- as.data.frame(results_df[, c("Biomarker", "Interaction", "Estimate", "Std.Error", "T_value", "P_value")])

kable(results_df, col.names = c("Biomarker", "Variable", "Estimate", "Std.Error", "t value", "P-value"))  %>%
 kable_styling("striped", full_width = T) %>%
 column_spec(1, bold = T) %>%
 collapse_rows(columns = 1, valign = "middle") 
```

In PTAU181 analysis, low intensity CHAMPS value is a predictor with a significance of 0.05.
```{r}
median_int <- median(data_champs_PTAU181$bl_low_z, na.rm = TRUE)

data_champs_PTAU181$int_group <- ifelse(data_champs_PTAU181$bl_low_z > median_int, "Above Median", "Below Median")

plot_below <- ggplot(data_champs_PTAU181[data_champs_PTAU181$int_group == "Below Median",], aes(x = time, y = PTAU181_zscore)) +
  geom_point(color = "blue") +
  geom_smooth(color = "blue") +
  labs(title = "Standardized Biomarker PTAU181 Values over Time \nSince Baseline (Below Median Low Intensity Value)",
       x = "Time (years)",
       y = "Standardized PTAU181 Score") +
  theme_minimal()

plot_above <- ggplot(data_champs_PTAU181[data_champs_PTAU181$int_group == "Above Median",], aes(x = time, y = PTAU181_zscore)) +
  geom_point(color = "red") +
  geom_smooth(color = "red") +
  labs(title = "Standardized Biomarker PTAU181 Values over Time \nSince Baseline (Above Median Low Intensity Value)",
       x = "Time (years)",
       y = "Standardized PTAU181 Score") +
  theme_minimal()
grid.arrange(plot_below, plot_above, ncol = 2)
```

High Intensity
```{r}
# High intensity
# Fit the linear mixed model
model_GFAP_high <- lmerTest::lmer(GFAP_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_high_z) + (1 + time | SUBJECT_ID), data = data_champs_GFAP)
model_NFL_high <- lmerTest::lmer(NFL_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_high_z) + (1 + time | SUBJECT_ID), data = data_champs_NFL)
model_PTAU181_high <- lmerTest::lmer(PTAU181_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_high_z) + (1 + time | SUBJECT_ID), data = data_champs_PTAU181)
model_AB42AB40_high <- lmerTest::lmer(AB42AB40_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_high_z) + (1 + time | SUBJECT_ID), data = data_champs_AB42AB40)
model_sTREM2_high <- lmerTest::lmer(sTREM2_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_high_z) + (1 + time | SUBJECT_ID), data = data_champs_sTREM2)
model_YKL40_high <- lmerTest::lmer(YKL40_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z+ bl_high_z) + (1 + time | SUBJECT_ID), data = data_champs_YKL40)

# View model summary
summary(model_GFAP_high)
summary(model_NFL_high)
summary(model_PTAU181_high)
summary(model_AB42AB40_high)
summary(model_sTREM2_high)
summary(model_YKL40_high)
```

```{r}
# Create a list of models
models <- list(
  GFAP = model_GFAP_high,
  NFL = model_NFL_high,
  PTAU181 = model_PTAU181_high,
  AB42AB40 = model_AB42AB40_high,
  sTREM2 = model_sTREM2_high,
  YKL40 = model_YKL40_high
)

results <- lapply(models, extract_results)
results_df <- do.call(rbind, results)
# Convert the row names (biomarker names) into a column
results_df <- data.frame(Biomarker = rep(names(models), each = 2), results_df, row.names = NULL)
results_df$Interaction <- rep(c("High Intensity", "High Intensity * Time"), length(models))
results_df <- as.data.frame(results_df[, c("Biomarker", "Interaction", "Estimate", "Std.Error", "T_value", "P_value")])

kable(results_df, col.names = c("Biomarker", "Variable", "Estimate", "Std.Error", "t value", "P-value"))  %>%
 kable_styling("striped", full_width = T) %>%
 column_spec(1, bold = T) %>%
 collapse_rows(columns = 1, valign = "middle") 
```

In NFL analysis, the interaction of high intensity CHAMPS value with time is a predictor with a significance of 0.01.
```{r}
median_int <- median(data_champs_NFL$bl_high_z, na.rm = TRUE)

data_champs_NFL$int_group <- ifelse(data_champs_NFL$bl_high_z > median_int, "Above Median", "Below Median")

plot_below <- ggplot(data_champs_NFL[data_champs_NFL$int_group == "Below Median",], aes(x = time, y = NFL_zscore)) +
  geom_point(color = "blue") +
  geom_smooth(color = "blue") +
  labs(title = "Standardized Biomarker NFL Values over Time \nSince Baseline (Below Median High Intensity Value)",
       x = "Time (years)",
       y = "Standardized NFL Score") +
  theme_minimal()

plot_above <- ggplot(data_champs_NFL[data_champs_NFL$int_group == "Above Median",], aes(x = time, y = NFL_zscore)) +
  geom_point(color = "red") +
  geom_smooth(color = "red") +
  labs(title = "Standardized Biomarker NFL Values over Time \nSince Baseline (Above Median High Intensity Value)",
       x = "Time (years)",
       y = "Standardized NFL Score") +
  theme_minimal()
grid.arrange(plot_below, plot_above, ncol = 2)
```

All Intensity
```{r}
# All intensity
# Fit the linear mixed model
model_GFAP_all <- lmerTest::lmer(GFAP_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_all_z) + (1 + time | SUBJECT_ID), data = data_champs_GFAP)
model_NFL_all <- lmerTest::lmer(NFL_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_all_z) + (1 + time | SUBJECT_ID), data = data_champs_NFL)
model_PTAU181_all <- lmerTest::lmer(PTAU181_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_all_z) + (1 + time | SUBJECT_ID), data = data_champs_PTAU181)
model_AB42AB40_all <- lmerTest::lmer(AB42AB40_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_all_z) + (1 + time | SUBJECT_ID), data = data_champs_AB42AB40)
model_sTREM2_all <- lmerTest::lmer(sTREM2_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_all_z) + (1 + time | SUBJECT_ID), data = data_champs_sTREM2)
model_YKL40_all <- lmerTest::lmer(YKL40_zscore ~ time * (Age_CHAMPS_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_all_z) + (1 + time | SUBJECT_ID), data = data_champs_YKL40)

# View model summary
summary(model_GFAP_all)
summary(model_NFL_all)
summary(model_PTAU181_all)
summary(model_AB42AB40_all)
summary(model_sTREM2_all)
summary(model_YKL40_all)
```

```{r}
# Create a list of models
models <- list(
  GFAP = model_GFAP_all,
  NFL = model_NFL_all,
  PTAU181 = model_PTAU181_all,
  AB42AB40 = model_AB42AB40_all,
  sTREM2 = model_sTREM2_all,
  YKL40 = model_YKL40_all
)

results <- lapply(models, extract_results)
results_df <- do.call(rbind, results)
# Convert the row names (biomarker names) into a column
results_df <- data.frame(Biomarker = rep(names(models), each = 2), results_df, row.names = NULL)
results_df$Interaction <- rep(c("All Intensity", "All Intensity * Time"), length(models))
results_df <- as.data.frame(results_df[, c("Biomarker", "Interaction", "Estimate", "Std.Error", "T_value", "P_value")])

kable(results_df, col.names = c("Biomarker", "Variable", "Estimate", "Std.Error", "t value", "P-value"))  %>%
 kable_styling("striped", full_width = T) %>%
 column_spec(1, bold = T) %>%
 collapse_rows(columns = 1, valign = "middle") 
```

In NFL analysis, the interaction of all intensity CHAMPS value with time is a predictor with a significance of 0.01.
```{r}
median_int <- median(data_champs_NFL$bl_all_z, na.rm = TRUE)

data_champs_NFL$int_group <- ifelse(data_champs_NFL$bl_all_z > median_int, "Above Median", "Below Median")

plot_below <- ggplot(data_champs_NFL[data_champs_NFL$int_group == "Below Median",], aes(x = time, y = NFL_zscore)) +
  geom_point(color = "blue") +
  geom_smooth(color = "blue") +
  labs(title = "Standardized Biomarker NFL Values over Time \nSince Baseline (Below Median All Intensity Value)",
       x = "Time (years)",
       y = "Standardized NFL Score") +
  theme_minimal()

plot_above <- ggplot(data_champs_NFL[data_champs_NFL$int_group == "Above Median",], aes(x = time, y = NFL_zscore)) +
  geom_point(color = "red") +
  geom_smooth(color = "red") +
  labs(title = "Standardized Biomarker NFL Values over Time \nSince Baseline (Above Median All Intensity Value)",
       x = "Time (years)",
       y = "Standardized NFL Score") +
  theme_minimal()
grid.arrange(plot_below, plot_above, ncol = 2)
```

### Actigraphy Analyses
```{r}
# prepare data for regression analysis
model_vars = c("Age_Act_z", "bl_sex", "bl_APOE4", "bl_BMI_z", "bl_LTAC10_z","time")

# mutate baseline characteristics
data_act_model <- data_act_clean %>%
  mutate(time = AgeAtVisit - Age_Act) %>%
  arrange(SUBJECT_ID, VISITNO) %>%
  group_by(SUBJECT_ID) %>%
  mutate(bl_sex = ifelse(first_act_visit == 1, Sex_F, NA),
         bl_APOE4 = ifelse(first_act_visit == 1, APOE4, NA),
         bl_BMI = ifelse(first_act_visit == 1, BMI, NA),
         bl_LTAC10 = ifelse(first_act_visit == 1, LTAC10, NA)
         ) %>%
  # standardize continuous predictors
  mutate(bl_sex = as.factor(bl_sex),
         bl_APOE4 = as.factor(bl_APOE4),
         Age_Act_z = (Age_Act - mean(data_act_clean_bl$Age_Act, na.rm = TRUE)) / sd(data_act_clean_bl$Age_Act, na.rm = TRUE),
         bl_BMI_z = (bl_BMI - mean(data_act_clean_bl$BMI, na.rm = TRUE)) / sd(data_act_clean_bl$BMI, na.rm = TRUE),
         bl_LTAC10_z = (bl_LTAC10 - mean(data_act_clean_bl$LTAC10, na.rm = TRUE)) / sd(data_act_clean_bl$LTAC10, na.rm = TRUE)
         ) %>%
  fill(bl_sex, .direction = "down") %>%
  fill(bl_APOE4, .direction = "down") %>%
  fill(bl_BMI_z, .direction = "down") %>%
  fill(bl_LTAC10_z, .direction = "down")

data_act_GFAP <- data_act_model %>%
  select(c(SUBJECT_ID, model_vars, 
           GFAP_zscore, GFAP_outlier)) %>%
  filter(GFAP_outlier == 0) %>%
  select(-c(GFAP_outlier))

data_act_NFL <- data_act_model %>%
  select(c(SUBJECT_ID, model_vars, 
           NFL_zscore, NFL_outlier)) %>%
  filter(NFL_outlier == 0) %>%
  select(-c(NFL_outlier))

data_act_PTAU181 <- data_act_model %>%
  select(c(SUBJECT_ID, model_vars, 
           PTAU181_zscore, PTAU181_outlier)) %>%
  filter(PTAU181_outlier == 0) %>%
  select(-c(PTAU181_outlier))

data_act_AB42AB40 <- data_act_model %>%
  select(c(SUBJECT_ID, model_vars, 
           AB42AB40_zscore, AB42AB40_outlier)) %>%
  filter(AB42AB40_outlier == 0) %>%
  select(-c(AB42AB40_outlier))

data_act_sTREM2 <- data_act_model %>%
  select(c(SUBJECT_ID, model_vars, 
           sTREM2_zscore, sTREM2_outlier)) %>%
  filter(sTREM2_outlier == 0) %>%
  select(-c(sTREM2_outlier))

data_act_YKL40 <- data_act_model %>%
  select(c(SUBJECT_ID, model_vars, 
           YKL40_zscore, YKL40_outlier)) %>%
  filter(YKL40_outlier == 0) %>%
  select(-c(YKL40_outlier))
```

```{r}
# Fit the linear mixed model
model_GFAP_act <- lmerTest::lmer(GFAP_zscore ~ time * (Age_Act_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_LTAC10_z) + (1 + time | SUBJECT_ID), data = data_act_GFAP)
model_NFL_act <- lmerTest::lmer(NFL_zscore ~ time * (Age_Act_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_LTAC10_z) + (1 + time | SUBJECT_ID), data = data_act_NFL)
model_PTAU181_act <- lmerTest::lmer(PTAU181_zscore ~ time * (Age_Act_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_LTAC10_z) + (1 + time | SUBJECT_ID), data = data_act_PTAU181)
model_AB42AB40_act <- lmerTest::lmer(AB42AB40_zscore ~ time * (Age_Act_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_LTAC10_z) + (1 + time | SUBJECT_ID), data = data_act_AB42AB40)
model_sTREM2_act <- lmerTest::lmer(sTREM2_zscore ~ time * (Age_Act_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_LTAC10_z) + (1 + time | SUBJECT_ID), data = data_act_sTREM2)
model_YKL40_act <- lmerTest::lmer(YKL40_zscore ~ time * (Age_Act_z + bl_sex + bl_APOE4 + bl_BMI_z + bl_LTAC10_z) + (1 + time | SUBJECT_ID), data = data_act_YKL40)

# View model summary
summary(model_GFAP_act)
summary(model_NFL_act)
summary(model_PTAU181_act)
summary(model_AB42AB40_act)
summary(model_sTREM2_act)
summary(model_YKL40_act)
```

```{r}
# Create a list of models
models <- list(
  GFAP = model_GFAP_act,
  NFL = model_NFL_act,
  PTAU181 = model_PTAU181_act,
  AB42AB40 = model_AB42AB40_act,
  sTREM2 = model_sTREM2_act,
  YKL40 = model_YKL40_act
)

results <- lapply(models, extract_results)
results_df <- do.call(rbind, results)
# Convert the row names (biomarker names) into a column
results_df <- data.frame(Biomarker = rep(names(models), each = 2), results_df, row.names = NULL)
results_df$Interaction <- rep(c("LTAC10", "LTAC10 * Time"), length(models))
results_df <- as.data.frame(results_df[, c("Biomarker", "Interaction", "Estimate", "Std.Error", "T_value", "P_value")])

kable(results_df, col.names = c("Biomarker", "Variable", "Estimate", "Std.Error", "t value", "P-value"))  %>%
 kable_styling("striped", full_width = T) %>%
 column_spec(1, bold = T) %>%
 collapse_rows(columns = 1, valign = "middle") 
```